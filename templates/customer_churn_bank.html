<!-- templates\customer_churn_bank.html -->
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>銀行客戶流失預測 - 客戶流失預測平台</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/customer_churn_bank.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/topbar_menu.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/general.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/fab_color_control.css') }}">
</head>
<body>

    <header id="topbarMenu">
        <button class="topbar-toggle-button" id="topbarToggleButton">
            <svg class="topbar-toggle-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M471.1 297.4C483.6 309.9 483.6 330.2 471.1 342.7L279.1 534.7C266.6 547.2 246.3 547.2 233.8 534.7C221.3 522.2 221.3 501.9 233.8 489.4L403.2 320L233.9 150.6C221.4 138.1 221.4 117.8 233.9 105.3C246.4 92.8 266.7 92.8 279.2 105.3L471.2 297.3z"/></svg>
        </button>
        <div class="topbar-brand">
            <svg class="topbar-brand-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M184 120C184 89.1 209.1 64 240 64L264 64C281.7 64 296 78.3 296 96L296 544C296 561.7 281.7 576 264 576L232 576C202.2 576 177.1 555.6 170 528C169.3 528 168.7 528 168 528C123.8 528 88 492.2 88 448C88 430 94 413.4 104 400C84.6 385.4 72 362.2 72 336C72 305.1 89.6 278.2 115.2 264.9C108.1 252.9 104 238.9 104 224C104 179.8 139.8 144 184 144L184 120zM456 120L456 144C500.2 144 536 179.8 536 224C536 239 531.9 253 524.8 264.9C550.5 278.2 568 305 568 336C568 362.2 555.4 385.4 536 400C546 413.4 552 430 552 448C552 492.2 516.2 528 472 528C471.3 528 470.7 528 470 528C462.9 555.6 437.8 576 408 576L376 576C358.3 576 344 561.7 344 544L344 96C344 78.3 358.3 64 376 64L400 64C430.9 64 456 89.1 456 120z"/></svg>
            <span class="topbar-brand-text">模型預測網站</span>
        </div>
        <div class="topbar-nav-links">
            <a class="topbar-nav-item {% if request.path == url_for('index') %} active {% endif %}" href="{{ url_for('index') }}" >
                <button class="topbar-nav-button">
                    <svg class="topbar-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M298.2 72.6C310.5 61.2 329.5 61.2 341.7 72.6L432 156.3L432 144C432 126.3 446.3 112 464 112L496 112C513.7 112 528 126.3 528 144L528 245.5L565.8 280.6C575.4 289.6 578.6 303.5 573.8 315.7C569 327.9 557.2 336 544 336L528 336L528 512C528 547.3 499.3 576 464 576L176 576C140.7 576 112 547.3 112 512L112 336L96 336C82.8 336 71 327.9 66.2 315.7C61.4 303.5 64.6 289.5 74.2 280.6L298.2 72.6zM304 384C277.5 384 256 405.5 256 432L256 528L384 528L384 432C384 405.5 362.5 384 336 384L304 384z"/></svg>
                    <span class="topbar-nav-text">首頁</span>
                </button>
            </a>
            <a class="topbar-nav-item {% if request.path == url_for('customer_churn_bank_page') %} active {% endif %}" href="{{ url_for('customer_churn_bank_page') }}" >
                <button class="topbar-nav-button">
                    <svg class="topbar-nav-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path path fill="currentColor" d="M335.9 84.2C326.1 78.6 314 78.6 304.1 84.2L80.1 212.2C67.5 219.4 61.3 234.2 65 248.2C68.7 262.2 81.5 272 96 272L128 272L128 480L128 480L76.8 518.4C68.7 524.4 64 533.9 64 544C64 561.7 78.3 576 96 576L544 576C561.7 576 576 561.7 576 544C576 533.9 571.3 524.4 563.2 518.4L512 480L512 272L544 272C558.5 272 571.2 262.2 574.9 248.2C578.6 234.2 572.4 219.4 559.8 212.2L335.8 84.2zM464 272L464 480L400 480L400 272L464 272zM352 272L352 480L288 480L288 272L352 272zM240 272L240 480L176 480L176 272L240 272zM320 160C337.7 160 352 174.3 352 192C352 209.7 337.7 224 320 224C302.3 224 288 209.7 288 192C288 174.3 302.3 160 320 160z"/></svg>
                    <span class="topbar-nav-text">客戶流失 銀行</span>
                </button>
            </a>
        </div>
    </header>

    <div class="topbar-content-gap" id="topbarContentGap"></div>

    <div id="customerChurnBank">
        <h2 class="bank-h2">銀行客戶流失 - 預測分析模型</h2>
        
        <div class="bank-panel-grid">
            
            <div class="api-key-panel card">
                <h2 class="card-title"><i class="fas fa-key mr-2"></i> Gemini API 啟用</h2>
                <div class="api-key-container">
                    <input type="password" id="apiKey" placeholder="請輸入 Gemini API Key..." class="theme-input-field" title="在此輸入您的 Gemini API Key">
                    <button id="saveApiKeyBtn" class="analyze-btn analyze-predict-only" title="啟用 Gemini AI 功能">
                        <i class="fas fa-check"></i>
                        <span class="key-status-text">尚未啟用</span>
                    </button>
                </div>
                <p id="apiStatusMsg" class="text-sm mt-2 text-red-500">請輸入 Key 以啟用 AI 解釋功能。</p>
            </div>

            <div class="input-and-prompt-panel card">
                
                <div class="batch-upload-container">
                    <h2 class="card-title"><i class="fas fa-upload mr-2"></i> 批次 CSV 分析/客戶單筆輸入</h2>
                    <hr class="card-divider">
                    <div class="batch-upload-area">
                        <h3 class="card-title text-base font-semibold" style="margin-bottom: 0.5rem;"><i class="fas fa-file-csv mr-1"></i> 批次 CSV 分析</h3>
                        <p class="text-sm text-gray-500 mb-4">上傳包含客戶資料的 CSV 檔案進行批次預測。</p>
                        <div class="flex flex-col sm:flex-row gap-3">
                            <input type="file" id="csvFileInput" accept=".csv" class="theme-input-field flex-grow cursor-pointer" style="max-width: unset;">
                            <button id="uploadBatchBtn" class="analyze-btn analyze-predict-only">
                                <i class="fas fa-upload mr-1"></i>
                                <span>上傳並批次預測</span>
                            </button>
                        </div>
                    </div>
                </div>

                <hr class="card-divider">

                <div class="input-section">
                    <h2 class="card-title"><i class="fas fa-user-edit mr-2"></i> 單筆客戶特徵輸入 (10 項)</h2>
                    <div id="inputForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                        <div class="input-field-container">
                            <label>1. 信用分數 ( 350 - 850 )</label>
                            <input type="number" id="input_CreditScore" data-feature-name="CreditScore" value="700" step="1" class="theme-input-field">
                        </div>
                        <div class="input-field-container">
                            <label>2. 年齡 ( 18 - 100 歲 )</label>
                            <input type="number" id="input_Age" data-feature-name="Age" value="35" step="1" class="theme-input-field">
                        </div>
                        <div class="input-field-container">
                            <label>3. 服務年限 ( 0 - 10 年 )</label>
                            <input type="number" id="input_Tenure" data-feature-name="Tenure" value="8" step="1" class="theme-input-field">
                        </div>
                        <div class="input-field-container">
                            <label>4. 餘額 ( 0-300000 $ )</label>
                            <input type="number" id="input_Balance" data-feature-name="Balance" value="150000" class="theme-input-field">
                        </div>
                        
                        <div class="input-field-container dropdown-container" data-dropdown-id="NumOfProducts">
                            <label>5. 產品數量 ( 1 - 4 )</label>
                            <input type="text" id="input_NumOfProducts" data-feature-name="NumOfProducts" data-value="2" value="2" readonly class="theme-input-field dropdown-input" placeholder="選擇產品數量">
                            <div class="dropdown-list hidden">
                                <div class="dropdown-item" data-value="1">1</div>
                                <div class="dropdown-item" data-value="2">2</div>
                                <div class="dropdown-item" data-value="3">3</div>
                                <div class="dropdown-item" data-value="4">4</div>
                            </div>
                        </div>
                        
                        <div class="input-field-container dropdown-container" data-dropdown-id="HasCrCard">
                            <label>6. 持有信用卡 ( 0 : 否 / 1 : 是 )</label>
                            <input type="text" id="input_HasCrCard" data-feature-name="HasCrCard" data-value="1" value="1 (是)" readonly class="theme-input-field dropdown-input" placeholder="選擇是否持有信用卡">
                            <div class="dropdown-list hidden">
                                <div class="dropdown-item" data-value="0">0 (否)</div>
                                <div class="dropdown-item" data-value="1">1 (是)</div>
                            </div>
                        </div>
                        
                        <div class="input-field-container dropdown-container" data-dropdown-id="IsActiveMember">
                            <label>7. 活躍會員 ( 0 : 否 / 1 : 是 )</label>
                            <input type="text" id="input_IsActiveMember" data-feature-name="IsActiveMember" data-value="1" value="1 (是)" readonly class="theme-input-field dropdown-input" placeholder="選擇是否為活躍會員">
                            <div class="dropdown-list hidden">
                                <div class="dropdown-item" data-value="0">0 (否)</div>
                                <div class="dropdown-item" data-value="1">1 (是)</div>
                            </div>
                        </div>
                        
                        <div class="input-field-container">
                            <label>8. 估計薪資 ( 0 - 200000 $ )</label>
                            <input type="number" id="input_EstimatedSalary" data-feature-name="EstimatedSalary" value="100000" class="theme-input-field">
                        </div>

                        <div class="input-field-container dropdown-container" data-dropdown-id="Geography">
                            <label>9. 國家/地區 ( 0 : 法國 1 : 西班牙 2 : 德國 )</label>
                            <input type="text" id="input_Geography" data-feature-name="Geography" data-value="2" value="2 (德國)" readonly class="theme-input-field dropdown-input" placeholder="選擇國家/地區">
                            <div class="dropdown-list hidden">
                                <div class="dropdown-item" data-value="0">0 (法國)</div>
                                <div class="dropdown-item" data-value="1">1 (西班牙)</div>
                                <div class="dropdown-item" data-value="2">2 (德國)</div>
                            </div>
                        </div>
                        
                        <div class="input-field-container dropdown-container" data-dropdown-id="Gender">
                            <label>10. 性別 ( 0 : 男 / 1 : 女 )</label>
                            <input type="text" id="input_Gender" data-feature-name="Gender" data-value="1" value="1 (女)" readonly class="theme-input-field dropdown-input" placeholder="選擇性別">
                            <div class="dropdown-list hidden">
                                <div class="dropdown-item" data-value="0">0 (男)</div>
                                <div class="dropdown-item" data-value="1">1 (女)</div>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="card-divider">

                <div class="prompt-section">
                    <h2 class="card-title"><i class="fas fa-comment-dots mr-2"></i> AI 解釋/行動建議 指令</h2>
                    <div class="input-field-container">
                        <label>請輸入您希望 AI 如何解釋預測結果：</label>
                        <textarea id="aiPrompt" 
                                    rows="5" 
                                    class="theme-input-field"
                                    placeholder="例如: 假設我是客戶經理，請用專業且具體的語言，結合輸入參數解釋流失風險，並提供三個具體的維護行動建議。">請作為一名資產管理顧問，根據客戶的流失機率和輸入特徵，提供一份專業的風險分析報告，包含：1. 風險評估等級。2. 主要風險點。3. 建議採取的客戶留存行動。請使用條列式呈現並且簡單扼要，約500個Tokens內。</textarea>
                    </div>
                    
                    <div class="action-buttons-container flex flex-col sm:flex-row gap-3 mt-4">
                        <button id="analyzeBtn" class="analyze-btn analyze-full flex-grow" disabled>
                            <i class="fas fa-robot mr-1"></i>
                            <span>執行模型預測並取得 AI 解釋</span>
                        </button>
                        
                        <button id="predictOnlyBtn" class="analyze-btn analyze-predict-only flex-grow">
                            <i class="fas fa-chart-line mr-1"></i>
                            <span>僅執行模型預測</span>
                        </button>
                    </div>
                    <p id="errorMsg" class="text-sm mt-3 text-red-500 hidden"></p> 
                </div>
            </div>

            <div class="explanation-panel card">
                <h2 class="card-title"><i class="fas fa-lightbulb mr-2"></i> AI 解釋與行動建議</h2>
                <div id="explanationOutput" class="output-content">
                    <p id="initialMessage" class="initial-message">請先在上方輸入並**啟用**您的 Gemini API Key，然後輸入參數和指令，才能執行分析。</p>
                </div>
            </div>

            <div class="chart-panel card">
                <h2 class="card-title"><i class="fas fa-chart-area mr-2"></i> 模型內建輸出圖表顯示區</h2>
                <div id="chartDisplay" class="chart-display grid grid-cols-1  gap-4">
                    <div class="chart-placeholder flex items-center justify-center">圖表 1: **單一客戶局部 SHAP 影響力**</div>
                    <div class="chart-placeholder flex items-center justify-center">圖表 2: **模型全局 SHAP 摘要圖**</div>
                </div>
            </div>
        </div>

        <hr class="card-divider mt-8">
        <div id="batch-result-panel" class="card mt-6">
            <h2 class="card-title"><i class="fas fa-table mr-2"></i> 批次分析結果列表</h2>
            
            <div class="filter-controls">
                
                <div class="flex items-center gap-2">
                    <label for="idSearchInput" class="font-bold whitespace-nowrap text-gray-700">ID 搜索:</label>
                    <input type="text" id="idSearchInput" placeholder="輸入 ID 快速搜索..." class="theme-input-field w-32">
                </div>
                
                <div class="flex items-center gap-2">
                    <label for="thresholdInput" class="whitespace-nowrap text-gray-700">篩選流失機率大於：</label>
                    <input type="number" id="thresholdInput" value="50" min="0" max="100" step="1" class="theme-input-field text-center" style="width: 70px;">
                    <span class="whitespace-nowrap">%</span>
                    <button id="filterDataBtn" class="analyze-btn analyze-predict-only text-sm">
                        <i class="fas fa-filter mr-1"></i> 執行篩選
                    </button>
                </div>
                
                <div class="filter-stats text-sm text-gray-600" id="filterStats">
                    </div>
            </div>
            
            <div class="table-wrapper mt-4 overflow-x-auto">
                <table class="fl-table">
                    <thead>
                        <tr>
                            <th id="sortId" data-sort-key="id" data-sort-order="none">
                                ID <span class="sort-icon"><i class="fas fa-sort"></i></span>
                            </th>
                            <th id="sortProbability" data-sort-key="probability" data-sort-order="none">
                                流失機率 <span class="sort-icon"><i class="fas fa-sort"></i></span>
                            </th>
                            <th id="sortRisk" data-sort-key="risk" data-sort-order="none">
                                風險等級 <span class="sort-icon"><i class="fas fa-sort"></i></span>
                            </th>
                            </tr>
                    </thead>
                    <tbody id="batchResultBody">
                        <tr><td colspan="3" class="text-center p-5 text-gray-400">請上傳 CSV 檔案進行批次分析</td></tr>
                    </tbody>
                </table>
            </div>

            <div class="pagination-controls" id="paginationControls" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 1rem;">
                <button id="prevPageBtn" class="analyze-btn analyze-predict-only text-sm"><i class="fas fa-chevron-left"></i> 上一頁</button>
                <label for="pageInput" class="text-gray-700">前往:</label>
                <input type="number" id="pageInput" value="1" min="1" class="theme-input-field text-center" style="width: 60px;">
                <span id="pageInfo" class="text-gray-700"> / ?</span>
                <button id="nextPageBtn" class="analyze-btn analyze-predict-only text-sm">下一頁 <i class="fas fa-chevron-right"></i></button>
            </div>
            
        </div>
    </div>
    
    <div id="fabColorControl"> 
        <svg id="fabIcon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 640"><path fill="currentColor" d="M576 320C576 320.9 576 321.8 576 322.7C575.6 359.2 542.4 384 505.9 384L408 384C381.5 384 360 405.5 360 432C360 435.4 360.4 438.7 361 441.9C363.1 452.1 367.5 461.9 371.8 471.8C377.9 485.6 383.9 499.3 383.9 513.8C383.9 545.6 362.3 574.5 330.5 575.8C327 575.9 323.5 576 319.9 576C178.5 576 63.9 461.4 63.9 320C63.9 178.6 178.6 64 320 64C461.4 64 576 178.6 576 320zM192 352C192 334.3 177.7 320 160 320C142.3 320 128 334.3 128 352C128 369.7 142.3 384 160 384C177.7 384 192 369.7 192 352zM192 256C209.7 256 224 241.7 224 224C224 206.3 209.7 192 192 192C174.3 192 160 206.3 160 224C160 241.7 174.3 256 192 256zM352 160C352 142.3 337.7 128 320 128C302.3 128 288 142.3 288 160C288 177.7 302.3 192 320 192C337.7 192 352 177.7 352 160zM448 256C465.7 256 480 241.7 480 224C480 206.3 465.7 192 448 192C430.3 192 416 206.3 416 224C416 241.7 430.3 256 448 256z"/></svg> 
        <div id="fabContent"> 
            <div class="fab-panel-title">背景顏色調整</div> 
            <div class="fab-sliders"> 
                <label>R: <span id="fabValR">128</span></label> 
                <input type="range" id="fabRangeR" min="0" max="255" value="128"> 
                <label>G: <span id="fabValG">128</span></label> 
                <input type="range" id="fabRangeG" min="0" max="255" value="128"> 
                <label>B: <span id="fabValB">128</span></label> 
                <input type="range" id="fabRangeB" min="0" max="255" value="128"> 
                <label>A: <span id="fabValA">1</span></label> 
                <input type="range" id="fabRangeA" min="0" max="1" step="0.01" value="1"> 
            </div>
            <div class="fab-themes"> 
                <button class="fab-theme-btn" data-color="rgba(0,0,0,1)">黑色</button>
                <button class="fab-theme-btn" data-color="rgba(85,85,85,1)">深色</button>
                <button class="fab-theme-btn" data-color="rgba(128,128,128,1)">灰色</button>
            </div>
            <div class="fab-themes"> 
                <button class="fab-theme-btn" data-color="rgba(170,170,170,1)">淺色</button>
                <button class="fab-theme-btn" data-color="rgba(255,255,255,1)">白色</button>
                <button class="fab-theme-btn" id="fabRandomButton">隨機</button>       
            </div> 
        </div>
    </div>
    
    <script src="{{ url_for('static', filename='js/topbar_menu.js') }}"></script>
    <script src="{{ url_for('static', filename='js/customer_churn_bank.js') }}"></script>
    <script src="{{ url_for('static', filename='js/fab_color_control.js') }}"></script>

</body>
</html>