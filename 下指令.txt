Web_Model_Prediction/  <-- å°ˆæ¡ˆæ ¹ç›®éŒ„ï¼ŒåŒ…å« Web æœå‹™æ‰€éœ€çš„ä¸€åˆ‡ã€‚

â”‚

â”‚ # --------------------------- æ ¹ç›®éŒ„æ ¸å¿ƒæª”æ¡ˆ ---------------------------

â”‚ app.py                             # æ‡‰ç”¨ç¨‹å¼é€²å…¥é»ï¼šWeb æœå‹™ä¸»æª”æ¡ˆï¼ˆé€šå¸¸æ˜¯ Flask æˆ– FastAPI å•Ÿå‹•é»ï¼‰ï¼Œè² è²¬åˆå§‹åŒ–å’Œé‹è¡Œä¼ºæœå™¨ã€‚

â”‚ config.py                          # é…ç½®æª”æ¡ˆï¼šå­˜æ”¾æ‡‰ç”¨ç¨‹å¼çš„å„ç¨®è¨­å®šï¼Œå¦‚è³‡æ–™åº«é€£ç·šã€API é‡‘é‘°ã€æ¨¡å‹è·¯å¾‘ç­‰ã€‚

â”‚ requirements.txt                   # ä¾è³´å¥—ä»¶æ¸…å–®ï¼šåˆ—å‡ºé‹è¡Œæ­¤å°ˆæ¡ˆæ‰€éœ€çš„æ‰€æœ‰ Python å‡½å¼åº«åŠå…¶ç‰ˆæœ¬ï¼Œä¾›ç’°å¢ƒå»ºç½®ä½¿ç”¨ (pip install -r)ã€‚

â”‚ æª”æ¡ˆæ“ä½œæ‰‹å†Š.txt                    # å°ˆæ¡ˆæ–‡æª”ï¼šé—œæ–¼å¦‚ä½•æ“ä½œã€éƒ¨ç½²æˆ–ç¶­è­·æ­¤å°ˆæ¡ˆçš„æ‰‹å†Šæˆ–èªªæ˜ã€‚

â”‚ æª”æ¡ˆæ¶æ§‹.txt                        # å°ˆæ¡ˆæ–‡æª”ï¼šè¨˜éŒ„äº†ç•¶å‰çš„æª”æ¡ˆå’Œè³‡æ–™å¤¾çµæ§‹ã€‚

â”‚

â”œâ”€api                                # æ‡‰ç”¨ç¨‹å¼ä»‹é¢ (API) å®šç¾©ç›®éŒ„ï¼Œç”¨æ–¼å®šç¾© URL çµæ§‹ã€‚

â”‚  â””â”€churn_bank                      # é‡å° 'Churn_Bank' æ¨¡å‹çš„ API æ¨¡çµ„ã€‚

â”‚          predict                   # ã€ç©ºè³‡æ–™å¤¾æˆ–æª”æ¡ˆã€‘é€šå¸¸ä»£è¡¨ API çš„æœ€çµ‚ç«¯é»è·¯å¾‘ï¼Œä¾‹å¦‚ /api/churn_bank/predictï¼Œç”¨æ–¼åŸ·è¡Œé æ¸¬ã€‚

â”‚

â”œâ”€data                               # è³‡æ–™è³‡æºç›®éŒ„ï¼Œç”¨æ–¼å­˜æ”¾æ¨¡å‹è¨“ç·´å’Œéƒ¨ç½²æ‰€éœ€çš„è³‡æ–™ã€‚

â”‚  â”œâ”€datasets                        # è³‡æ–™é›†å­ç›®éŒ„ã€‚

â”‚  â”‚      placeholder.txt            # ã€å¯åˆªé™¤ã€‘ä½”ä½æª”æ¡ˆï¼Œç”¨æ–¼ç¢ºä¿ç‰ˆæœ¬æ§åˆ¶ç³»çµ± (å¦‚ Git) è¿½è¹¤åˆ°é€™å€‹ç©ºè³‡æ–™å¤¾ã€‚

â”‚  â”‚      test.csv                   # æ¸¬è©¦æ•¸æ“šé›†ï¼šç”¨æ–¼è©•ä¼°æ¨¡å‹æ€§èƒ½çš„æ•¸æ“šã€‚

â”‚  â”‚      train.csv                  # è¨“ç·´æ•¸æ“šé›†ï¼šç”¨æ–¼è¨“ç·´ XGBoost æ¨¡å‹çš„åŸå§‹æ•¸æ“šã€‚

â”‚  â”‚

â”‚  â””â”€models                          # æ¨¡å‹å„²å­˜ç›®éŒ„ã€‚

â”‚          placeholder.txt           # ã€å¯åˆªé™¤ã€‘ä½”ä½æª”æ¡ˆã€‚

â”‚          XGBoost_Final_Tuned_run_v2_preprocessing.joblib # ã€æ ¸å¿ƒè³‡ç”¢ã€‘è¨“ç·´å¥½çš„ XGBoost æ¨¡å‹æª”æ¡ˆï¼ŒWeb æœå‹™ç”¨ä¾†è¼‰å…¥ä¸¦åŸ·è¡Œé æ¸¬ã€‚

â”‚

â”œâ”€projects                           # æ¨¡å‹é–‹ç™¼å’Œå¯¦é©—ç›®éŒ„ã€‚

â”‚  â”œâ”€Churn_Bank_code                 # éŠ€è¡Œå®¢æˆ¶æµå¤±æ¨¡å‹ (Churn Bank) çš„é–‹ç™¼ä»£ç¢¼ã€‚

â”‚  â”‚      Churn_Bank.ipynb           # Jupyter Notebookï¼šè¨˜éŒ„äº†æ•¸æ“šæ¢ç´¢ã€ç‰¹å¾µå·¥ç¨‹å’Œæ¨¡å‹è¨“ç·´éç¨‹çš„ç­†è¨˜æœ¬ã€‚

â”‚  â”‚      churn_bank_train.py        # æ¨¡å‹è¨“ç·´è…³æœ¬ï¼šç”¨æ–¼é‡æ–°åŸ·è¡Œæˆ–è‡ªå‹•åŒ–è¨“ç·´æ¨¡å‹çš„ Python è…³æœ¬ã€‚

â”‚  â”‚

â”‚  â””â”€Churn_Telco_code                # é›»ä¿¡å®¢æˆ¶æµå¤±æ¨¡å‹ (Churn Telco) çš„é–‹ç™¼ä»£ç¢¼ã€‚

â”‚          Churn_Telco.ipynb         # Jupyter Notebookï¼šè¨˜éŒ„äº† Churn Telco æ¨¡å‹çš„é–‹ç™¼ç­†è¨˜ã€‚

â”‚

â”œâ”€routes                             # è·¯ç”±å±¤ç›®éŒ„ï¼šè² è²¬è™•ç† Web è«‹æ±‚çš„æ¨¡çµ„ã€‚

â”‚  â”‚  churn_bank_routes.py           # è·¯ç”±å®šç¾©ï¼šå°‡ /api/churn_bank/ ç›¸é—œçš„ URL è«‹æ±‚å°å‘åˆ°ç›¸å°æ‡‰çš„æœå‹™å‡½å¼ã€‚

â”‚  â”‚

â”‚  â””â”€__pycache__                     # ã€å¯åˆªé™¤ã€‘Python è‡ªå‹•ç”Ÿæˆçš„ä½å…ƒç¢¼å¿«å–è³‡æ–™å¤¾ (.pyc æª”æ¡ˆ)ã€‚

â”‚          churn_bank_routes.cpython-311.pyc

â”‚

â”œâ”€services                           # æœå‹™å±¤ç›®éŒ„ï¼šè² è²¬è™•ç†æ¥­å‹™é‚è¼¯çš„æ¨¡çµ„ã€‚

â”‚  â”‚  churn_bank_service.py          # æ¥­å‹™é‚è¼¯ï¼šåŒ…å«è¼‰å…¥ XGBoost æ¨¡å‹ã€æ•¸æ“šé è™•ç†å’ŒåŸ·è¡Œé æ¸¬çš„æ ¸å¿ƒå‡½å¼ã€‚

â”‚  â”‚  gemini_service.py              # æ¥­å‹™é‚è¼¯ï¼šåŒ…å«å‘¼å« Gemini AI æ¨¡å‹é€²è¡Œäº’å‹•æˆ–é¡å¤–è™•ç†çš„å‡½å¼ã€‚

â”‚  â”‚

â”‚  â””â”€__pycache__                     # ã€å¯åˆªé™¤ã€‘Python è‡ªå‹•ç”Ÿæˆçš„ä½å…ƒç¢¼å¿«å–è³‡æ–™å¤¾ (.pyc æª”æ¡ˆ)ã€‚

â”‚          churn_bank_service.cpython-313.pyc

â”‚          gemini_service.cpython-313.pyc

â”‚

â”œâ”€static                             # éœæ…‹è³‡æºç›®éŒ„ï¼šå­˜æ”¾å‰ç«¯ç¶²é æ‰€éœ€çš„æª”æ¡ˆã€‚

â”‚  â”œâ”€css                             # æ¨£å¼è¡¨æª”æ¡ˆ (Cascading Style Sheets)ã€‚

â”‚  â”‚      base_churn.css             # åŸºç¤æˆ–å…±ç”¨çš„ CSS æ¨£å¼ã€‚

â”‚  â”‚      Churn_Bank.css             # Churn Bank é é¢å°ˆå±¬çš„ CSS æ¨£å¼ã€‚

â”‚  â”‚      Churn_Telco.css            # Churn Telco é é¢å°ˆå±¬çš„ CSS æ¨£å¼ã€‚

â”‚  â”‚      Color_BG_Control.css       # æ§åˆ¶èƒŒæ™¯é¡è‰²çš„æ¨£å¼ã€‚

â”‚  â”‚      index.css                  # é¦–é å°ˆå±¬çš„ CSS æ¨£å¼ã€‚

â”‚  â”‚

â”‚  â”œâ”€img                             # åœ–ç‰‡æª”æ¡ˆã€‚

â”‚  â”‚      Churn_Bank.jpg             # Churn Bank ç›¸é—œåœ–ç‰‡ã€‚

â”‚  â”‚      Churn_Telco.jpg            # Churn Telco ç›¸é—œåœ–ç‰‡ã€‚

â”‚  â”‚      doro.gif                   # å¯èƒ½æ˜¯æŸå€‹å‹•ç•«æˆ–åœ–æ¨™ã€‚

â”‚  â”‚      logo.png                   # æ‡‰ç”¨ç¨‹å¼çš„æ¨™èªŒåœ–ç‰‡ã€‚

â”‚  â”‚

â”‚  â””â”€js                              # JavaScript æª”æ¡ˆ (ç”¨æ–¼å‰ç«¯äº’å‹•é‚è¼¯)ã€‚

â”‚          base_churn.js             # åŸºç¤æˆ–å…±ç”¨çš„ JavaScript è…³æœ¬ã€‚

â”‚          Churn_Bank.js             # Churn Bank é é¢å°ˆå±¬çš„ JavaScript è…³æœ¬ã€‚

â”‚          Churn_Telco.js            # Churn Telco é é¢å°ˆå±¬çš„ JavaScript è…³æœ¬ã€‚

â”‚          Color_BG_Control.js       # æ§åˆ¶èƒŒæ™¯æˆ–é¡è‰²çš„ JavaScript é‚è¼¯ã€‚

â”‚

â”œâ”€templates                          # æ¨¡æ¿ç›®éŒ„ï¼šå­˜æ”¾ Web æœå‹™å›å‚³çµ¦ç€è¦½å™¨çš„ HTML æª”æ¡ˆã€‚

â”‚      base_Churn.html               # åŸºç¤/çˆ¶ç´šæ¨¡æ¿ï¼šå…¶ä»– HTML é é¢å¯èƒ½æœƒç¹¼æ‰¿çš„éª¨æ¶æ¨¡æ¿ã€‚

â”‚      Churn_Bank.html               # Churn Bank æ¨¡å‹çš„çµæœæˆ–è¼¸å…¥é é¢ã€‚

â”‚      Churn_Telco.html              # Churn Telco æ¨¡å‹çš„çµæœæˆ–è¼¸å…¥é é¢ã€‚

â”‚      index.html                    # ç¶²ç«™çš„é¦–é ã€‚

â”‚

â””â”€__pycache__                        # ã€å¯åˆªé™¤ã€‘æ ¹ç›®éŒ„ä¸‹ Python è‡ªå‹•ç”Ÿæˆçš„ä½å…ƒç¢¼å¿«å–è³‡æ–™å¤¾ã€‚

        config.cpython-311.pyc

ä»¥ä¸Šç‚ºæˆ‘çš„ç¨‹å¼ç¢¼æ¶æ§‹ ç›®å‰è£¡é¢å·²ç¶“æœ‰å®Œæ•´çš„ç¨‹å¼ç¢¼

æˆ‘æœƒè²¼çµ¦ä½ ç›®å‰é‡é»ç¨‹å¼ç¢¼



requirements.txt

Flask>=2.0.0

pandas>=1.5.0

numpy>=1.24.0

joblib>=1.2.0

scikit-learn>=1.2.0

xgboost>=1.7.0

optuna>=3.0.0

optuna-integration>=0.3.0

matplotlib>=3.7.0

plotly>=5.15.0

seaborn>=0.12.2

google-genai>=0.1.0



config.py

# config.py

# æ‡‰ç”¨ç¨‹å¼é…ç½®è¨­å®š



import os



class Config:

    SECRET_KEY = os.environ.get('SECRET_KEY') or 'a_hard_to_guess_string'

    GEMINI_API_KEY_ENV = 'GEMINI_API_KEY' # ç’°å¢ƒè®Šæ•¸åç¨±

    # ğŸš¨ æ›´æ–°æ¨¡å‹è·¯å¾‘ä»¥åŒ¹é…æ‚¨çš„æ–°æ¨¡å‹æª”æ¡ˆ

    MODEL_BANK_PATH = 'data/models/XGBoost_Final_Tuned_run_v2_preprocessing.joblib' 



class DevelopmentConfig(Config):

    DEBUG = True



class ProductionConfig(Config):

    DEBUG = False



app.py

from flask import Flask, render_template

from routes.churn_bank_routes import churn_bank_bp  # Blueprint

import os



# --- Flask æ‡‰ç”¨ç¨‹å¼ ---

app = Flask(__name__)



# è¨»å†Š Blueprint

app.register_blueprint(churn_bank_bp, url_prefix='/api/churn_bank')



# --- å‰ç«¯é é¢è·¯ç”± ---

@app.route('/')

def index():

    return render_template('index.html')



@app.route('/customer_churn_bank_model')

def bank_churn_page():

    return render_template('Churn_Bank.html')



@app.route('/customer_churn_telco_model')

def telco_churn_page():

    return render_template('Churn_Telco.html')



# --- å•Ÿå‹•æœå‹™ ---

if __name__ == '__main__':

    print("æœå‹™å™¨å•Ÿå‹•...")

    app.run(debug=True, port=5000)



gemini_service.py

# services/gemini_service.py



import os

from google import genai

from google.genai.errors import APIError



class GeminiService:

    def __init__(self, api_key: str):

        # åˆå§‹åŒ– Gemini Client

        if not api_key:

            raise ValueError("Gemini API Key ç¼ºå¤±ã€‚")

        

        try:

            self.client = genai.Client(api_key=api_key)

        except Exception as e:

            raise RuntimeError(f"åˆå§‹åŒ– Gemini Client å¤±æ•—: {e}")



    def generate_churn_explanation(self, input_features: dict, prediction_result: dict, feature_importance: str) -> str:

        """

        æ ¹æ“šè¼¸å…¥æ•¸æ“šã€é æ¸¬çµæœå’Œç‰¹å¾µé‡è¦æ€§ï¼Œç”Ÿæˆå‹å¥½çš„æµå¤±è§£é‡‹ã€‚

        

        Args:

            input_features: åŸå§‹å®¢æˆ¶è¼¸å…¥æ•¸æ“šã€‚

            prediction_result: åŒ…å« 'probability' (æµå¤±æ©Ÿç‡) å’Œ 'prediction' (æ˜¯å¦æµå¤±) çš„å­—å…¸ã€‚

            feature_importance: æ¨¡å‹ï¼ˆå¦‚ CatBoostï¼‰è¨ˆç®—å‡ºçš„ SHAP æˆ–ç‰¹å¾µé‡è¦æ€§æ–‡æœ¬ã€‚

        

        Returns:

            AI ç”Ÿæˆçš„è§£é‡‹æ–‡æœ¬ã€‚

        """

        

        # æ ¼å¼åŒ–å®¢æˆ¶ç‰¹å¾µ

        formatted_features = "\n".join([f"- {k}: {v}" for k, v in input_features.items()])

        

        # å®šç¾© Prompt

        prompt = f"""

        ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„é‡‘èé¢¨éšªåˆ†æå¸«ï¼Œè«‹æ ¹æ“šä»¥ä¸‹å®¢æˆ¶è³‡è¨Šã€æµå¤±æ¨¡å‹é æ¸¬çµæœå’Œé—œéµå› ç´ ï¼Œç‚ºå®¢æˆ¶æä¾›ä¸€å€‹ç°¡æ½”ã€å°ˆæ¥­ä¸”å‹å–„çš„è§£é‡‹å ±å‘Šï¼Œä¸¦çµ¦å‡ºæ˜ç¢ºçš„è¡Œå‹•å»ºè­°ã€‚



        --- å®¢æˆ¶è¼¸å…¥æ•¸æ“š ---

        {formatted_features}



        --- æ¨¡å‹é æ¸¬çµæœ ---

        å®¢æˆ¶æµå¤±æ©Ÿç‡: {prediction_result.get('probability', 'N/A')}%

        æ¨¡å‹é æ¸¬: {'æµå¤± (Exited)' if prediction_result.get('prediction', 0) == 1 else 'æœªæµå¤± (Retained)'}



        --- é—œéµå½±éŸ¿å› ç´  (ç‰¹å¾µé‡è¦æ€§) ---

        {feature_importance}



        è«‹æ³¨æ„å ±å‘Šè¦æ±‚ï¼š

        1. å ±å‘Šæ‡‰åŒ…å«**é¢¨éšªæ‘˜è¦**ï¼ˆæµå¤±æ©Ÿç‡ï¼‰ã€‚

        2. ç°¡æ½”åˆ†æ**ä¸»è¦æµå¤±æˆ–ç•™å­˜åŸå› **ï¼ˆçµåˆç‰¹å¾µé‡è¦æ€§ï¼‰ã€‚

        3. æä¾›**ä¸€é …å…·é«”ä¸”å¯åŸ·è¡Œçš„è¡Œå‹•å»ºè­°**ã€‚

        4. å ±å‘Šç¸½é•·åº¦ä¸è¶…é 150 å­—ã€‚

        """



        try:

            response = self.client.models.generate_content(

                model='gemini-2.5-flash',

                contents=prompt,

            )

            return response.text.strip()

        except APIError as e:

            return f"Gemini API å‘¼å«å¤±æ•—: {e}"

        except Exception as e:

            return f"AI è§£é‡‹ç”Ÿæˆéç¨‹ä¸­ç™¼ç”ŸæœªçŸ¥éŒ¯èª¤: {e}"



churn_bank_service.py

# services/churn_bank_service.py



import joblib

import numpy as np

import os

import pandas as pd

from typing import Dict, Any



class ChurnBankService:

    def __init__(self, model_path: str):

        self.model = self._load_model(model_path)

        # âš ï¸ é€™è£¡æ‡‰å®šç¾©æ¨¡å‹è¨“ç·´æ™‚ä½¿ç”¨çš„ç‰¹å¾µé †åºå’Œç·¨ç¢¼

        self.feature_order = [

            'CreditScore', 'Gender', 'Age', 'Tenure', 'Balance', 

            'NumOfProducts', 'HasCrCard', 'IsActiveMember', 'EstimatedSalary', 

            'Geography_Germany', 'Geography_Spain', 'Gender_Male'

        ]



    def _load_model(self, model_path: str) -> Any:

        """è¼‰å…¥é è¨“ç·´çš„æ©Ÿå™¨å­¸ç¿’æ¨¡å‹ (ä¾‹å¦‚ CatBoost æˆ– Scikit-learn æ¨¡å‹)"""

        if not os.path.exists(model_path):

            raise FileNotFoundError(f"æ¨¡å‹æª”æ¡ˆæœªæ‰¾åˆ°: {model_path}")

        try:

            # ä½¿ç”¨ joblib æˆ– pickle è¼‰å…¥æ¨¡å‹

            model = joblib.load(model_path)

            print(f"æ¨¡å‹ {model_path} è¼‰å…¥æˆåŠŸã€‚")

            return model

        except Exception as e:

            raise RuntimeError(f"è¼‰å…¥æ¨¡å‹å¤±æ•—: {e}")



    def preprocess_and_predict(self, input_data: Dict[str, Any]) -> Dict[str, Any]:

        """

        è™•ç†è¼¸å…¥æ•¸æ“šï¼Œé€²è¡Œ One-Hot ç·¨ç¢¼ï¼Œç„¶å¾Œé€²è¡Œé æ¸¬ã€‚

        

        Args:

            input_data: ä¾†è‡ªå‰ç«¯çš„å®¢æˆ¶ç‰¹å¾µå­—å…¸ã€‚

            

        Returns:

            åŒ…å«é æ¸¬çµæœã€æ©Ÿç‡å’Œæ¨¡æ“¬ç‰¹å¾µé‡è¦æ€§çš„å­—å…¸ã€‚

        """

        

        # 1. å»ºç«‹ Pandas DataFrame

        df = pd.DataFrame([input_data])

        

        # 2. One-Hot ç·¨ç¢¼ (åªé‡å° 'Geography' å’Œ 'Gender')

        # âš ï¸ å¿…é ˆèˆ‡æ¨¡å‹è¨“ç·´æ™‚çš„ç·¨ç¢¼æ–¹å¼å®Œå…¨ä¸€è‡´

        df['Geography_Germany'] = (df['Geography'] == 'Germany').astype(int)

        df['Geography_Spain'] = (df['Geography'] == 'Spain').astype(int)

        # é è¨­æ³•åœ‹æ˜¯ 0, 0

        df['Gender_Male'] = (df['Gender'] == 'Male').astype(int)

        

        # 3. ç¢ºä¿ç‰¹å¾µé †åºèˆ‡æ¨¡å‹è¨“ç·´ä¸€è‡´

        # ç§»é™¤åŸå§‹åˆ†é¡åˆ—

        df = df.drop(columns=['Geography', 'Gender'])

        

        # ç¢ºä¿æ‰€æœ‰æ¨¡å‹æ‰€éœ€ç‰¹å¾µå­˜åœ¨ï¼Œä¸¦æŒ‰ç…§é †åºæ’åˆ—

        final_features = []

        for feat in self.feature_order:

            if feat in df.columns:

                final_features.append(df[feat].iloc[0])

            else:

                # è™•ç†æœªåœ¨åŸå§‹è¼¸å…¥ä¸­ä½†æ¨¡å‹éœ€è¦çš„æ¬„ä½ï¼ˆä¾‹å¦‚ Geography_France é è¨­ç‚º 0ï¼‰

                final_features.append(0) 



        # 4. è½‰æ›ç‚º NumPy é™£åˆ—

        X = np.array([final_features])



        # 5. é€²è¡Œé æ¸¬

        # æµå¤±æ©Ÿç‡ (å‡è¨­æ¨¡å‹è¼¸å‡ºæµå¤±çš„æ©Ÿç‡ï¼Œå³é¡åˆ¥ 1 çš„æ©Ÿç‡)

        probability_class_1 = self.model.predict_proba(X)[:, 1][0]

        

        # é æ¸¬é¡åˆ¥ (0: æœªæµå¤±, 1: æµå¤±)

        prediction = int(probability_class_1 >= 0.5)



        # 6. æ¨¡æ“¬/è¨ˆç®—ç‰¹å¾µé‡è¦æ€§ (âš ï¸ å¯¦éš›æ‡‰ç”¨ä¸­è«‹ä½¿ç”¨ SHAP æˆ– LIME åº«ä¾†è¨ˆç®—)

        mock_feature_importance = (

            f"å‰ 3 å¤§å½±éŸ¿å› ç´ :\n"

            f"1. é¤˜é¡ (Balance): é«˜é¤˜é¡å½±éŸ¿ä¿‚æ•¸ (+0.2)\n"

            f"2. å¹´é½¡ (Age): è¼ƒé«˜å¹´é½¡å½±éŸ¿ä¿‚æ•¸ (+0.15)\n"

            f"3. æ´»èºæœƒå“¡ (IsActiveMember): ç‹€æ…‹ç‚ºå¦å½±éŸ¿ä¿‚æ•¸ (-0.1)"

        )



        return {

            "prediction": prediction,

            "probability": round(probability_class_1 * 100, 2),

            "feature_importance": mock_feature_importance,

            # é€™è£¡å¯ä»¥åŠ å…¥ Base64 åœ–è¡¨æ•¸æ“š

            "charts": [

                 "data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mP8z8BQDwAEhQGAhKmMIQAAAABJRU5ErkJggg==" # 1x1 é€æ˜åƒç´ 

            ]

        }



churn_bank_routes.py

import os

import sys

import logging

from flask import Blueprint, jsonify, request

import joblib

import pandas as pd

import numpy as np

from werkzeug.exceptions import BadRequest

from typing import Any



# âœ… å°å…¥ç¹ªåœ–èˆ‡åœ–è¡¨è™•ç†åº«

import matplotlib.pyplot as plt

import io

import base64



# è¨­å®šå°ˆæ¡ˆè·¯å¾‘ï¼Œå°å…¥ config.py

sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

from config import DevelopmentConfig



# --- ç‰¹å¾µå·¥ç¨‹é¡ ---

class FeatureEngineerForAPI:

    @staticmethod

    def cast_columns(df: pd.DataFrame, int_cols: Any = None, cat_cols: Any = None) -> pd.DataFrame:

        df_copy = df.copy()

        if int_cols:

            for col in int_cols:

                if col in df_copy.columns:

                    df_copy[col] = df_copy[col].astype(int)

        if cat_cols:

            for col in cat_cols:

                if col in df_copy.columns:

                    df_copy[col] = df_copy[col].astype('category')

        return df_copy



    @staticmethod

    def run_v1_preprocessing(df: pd.DataFrame) -> pd.DataFrame:

        df_copy = df.copy()

        df_copy['Gender'] = df_copy['Gender'].astype(int)

        df_copy['Age_bin'] = pd.cut(df_copy['Age'], bins=[0, 25, 35, 45, 60, np.inf],

                                    labels=['very_young', 'young', 'mid', 'mature', 'senior']).astype('category')

        df_copy['Is_two_products'] = (df_copy['NumOfProducts'] == 2).astype(int)



        geo_map = {0: 'France', 1: 'Spain', 2: 'Germany'}

        df_copy['Geography'] = df_copy['Geography'].map(geo_map).astype('category')



        df_copy['Germany_Female'] = ((df_copy['Geography'] == 'Germany') & (df_copy['Gender'] == 1)).astype(int)

        df_copy['Germany_Inactive'] = ((df_copy['Geography'] == 'Germany') & (df_copy['IsActiveMember'] == 0)).astype(int)

        df_copy['Has_Zero_Balance'] = (df_copy['Balance'] == 0).astype(int)

        df_copy['Tenure_log'] = np.log1p(df_copy['Tenure'])



        int_cols = ['HasCrCard', 'IsActiveMember', 'NumOfProducts', 'Is_two_products',

                    'Has_Zero_Balance', 'Germany_Female', 'Germany_Inactive']

        cat_cols = ['Geography', 'Age_bin']

        df_copy = FeatureEngineerForAPI.cast_columns(df_copy, int_cols=int_cols, cat_cols=cat_cols)



        # ä¸åˆªé™¤ idï¼Œä¿ç•™èˆ‡æ¨¡å‹ä¸€è‡´

        cols_to_drop = ['CustomerId', 'Tenure', 'Surname', 'RowNumber']

        df_copy.drop(columns=[col for col in cols_to_drop if col in df_copy.columns], inplace=True, errors='ignore')



        return df_copy



    @staticmethod

    def run_v2_preprocessing(df: pd.DataFrame) -> pd.DataFrame:

        df_copy = FeatureEngineerForAPI.run_v1_preprocessing(df.copy())

        df_copy['is_mature_inactive_transit'] = (

                (df_copy['Has_Zero_Balance'] == 1) & (df_copy['IsActiveMember'] == 0) & (df_copy['Age'] > 40)

        ).astype(int)

        return df_copy



# --- æ—¥èªŒ ---

logger = logging.getLogger('ChurnBankRoute')

logger.setLevel(logging.INFO)



# --- è¼‰å…¥æ¨¡å‹ ---

MODEL = None

FEATURE_COLUMNS = None

try:

    MODEL_PATH = os.path.join(os.path.dirname(os.path.dirname(os.path.abspath(__file__))),

                              DevelopmentConfig.MODEL_BANK_PATH)

    if os.path.exists(MODEL_PATH):

        MODEL = joblib.load(MODEL_PATH)

        FEATURE_COLUMNS = getattr(MODEL, 'get_booster', lambda: None)()

        if FEATURE_COLUMNS:

            FEATURE_COLUMNS = MODEL.get_booster().feature_names

        logger.info(f"æˆåŠŸåŠ è¼‰æ¨¡å‹: {MODEL_PATH}")

    else:

        logger.warning(f"æ¨¡å‹æ–‡ä»¶ä¸å­˜åœ¨: {MODEL_PATH}, å°‡ä½¿ç”¨æ¨¡æ“¬é æ¸¬")

except Exception as e:

    logger.error(f"è¼‰å…¥æ¨¡å‹å¤±æ•—: {e}")



# --- Blueprint ---

churn_bank_bp = Blueprint('churn_bank_bp', __name__)



@churn_bank_bp.route('/predict', methods=['POST'])

def predict_churn():

    try:

        data = request.get_json()

        if not data:

            raise BadRequest("ç„¡æ•ˆçš„ JSON è«‹æ±‚")



        # æ•¸å€¼è½‰æ›ï¼Œè£œä¸Š id

        input_data = {

            'id': 0,  # âœ… è£œ id

            'CreditScore': float(data.get('CreditScore', 0)),

            'Age': float(data.get('Age', 0)),

            'Tenure': float(data.get('Tenure', 0)),

            'Balance': float(data.get('Balance', 0)),

            'NumOfProducts': float(data.get('NumOfProducts', 0)),

            'HasCrCard': float(data.get('HasCrCard', 0)),

            'IsActiveMember': float(data.get('IsActiveMember', 0)),

            'EstimatedSalary': float(data.get('EstimatedSalary', 0)),

            'Geography': float(data.get('Geography', 0)),

            'Gender': float(data.get('Gender', 0)),

            'CustomerId': 0,

            'Surname': 'A',

            'RowNumber': 0

        }



        input_df = pd.DataFrame([input_data])

        processed_df = FeatureEngineerForAPI.run_v2_preprocessing(input_df)



        # æ¨¡å‹å­˜åœ¨å‰‡é æ¸¬

        if MODEL is not None and FEATURE_COLUMNS is not None:

            missing_cols = set(FEATURE_COLUMNS) - set(processed_df.columns)

            if missing_cols:

                raise ValueError(f"ç¼ºå°‘å¿…è¦æ¬„ä½: {missing_cols}")

            X_predict = processed_df[FEATURE_COLUMNS]

            proba_churn = MODEL.predict_proba(X_predict)[:, 1][0]

        else:

            # æ¨¡å‹ä¸å­˜åœ¨ â†’ æ¨¡æ“¬

            score_risk = (850 - float(data.get('CreditScore', 650))) / 250

            age_risk = (float(data.get('Age', 40)) - 30) / 40

            proba_churn = float(np.clip(0.1 + score_risk * 0.4 + age_risk * 0.3, 0.01, 0.99))

            logger.info("ä½¿ç”¨æ¨¡æ“¬é æ¸¬")



        # å¯è®€æ€§è¼¸å‡º

        geography_map = {0: "æ³•åœ‹ (France)", 1: "è¥¿ç­ç‰™ (Spain)", 2: "å¾·åœ‹ (Germany)"}

        gender_map = {0: "ç”·æ€§ (Male)", 1: "å¥³æ€§ (Female)"}

        readable_data = {

            'ä¿¡ç”¨åˆ†æ•¸': data.get('CreditScore'),

            'å¹´é½¡': data.get('Age'),

            'æœå‹™å¹´é™': data.get('Tenure'),

            'é¤˜é¡': f"${float(data.get('Balance',0)):.2f}",

            'ç”¢å“æ•¸é‡': data.get('NumOfProducts'),

            'æŒæœ‰ä¿¡ç”¨å¡': "æ˜¯" if data.get('HasCrCard') == 1 else "å¦",

            'æ´»èºæœƒå“¡': "æ˜¯" if data.get('IsActiveMember') == 1 else "å¦",

            'ä¼°è¨ˆè–ªè³‡': f"${float(data.get('EstimatedSalary',0)):.2f}",

            'åœ‹å®¶/åœ°å€': geography_map.get(data.get('Geography'), 'æœªçŸ¥'),

            'æ€§åˆ¥': gender_map.get(data.get('Gender'), 'æœªçŸ¥')

        }



        explanation_prompt = f"å®¢æˆ¶ç‰¹å¾µ: {readable_data}ã€‚\næ¨¡å‹é æ¸¬çš„å®¢æˆ¶æµå¤±æ©Ÿç‡ç‚º {proba_churn:.4f}ã€‚"



        return jsonify({

            "status": "success",

            "prediction": float(proba_churn),

            "explanation_prompt": explanation_prompt

        })



    except BadRequest as e:

        logger.error(f"API è«‹æ±‚éŒ¯èª¤: {e}")

        return jsonify({"error": str(e)}), 400

    except ValueError as e:

        logger.error(f"æ•¸æ“šè™•ç†éŒ¯èª¤: {e}")

        return jsonify({"error": f"æ•¸æ“šè™•ç†å¤±æ•—: {e}"}), 400

    except Exception as e:

        logger.error(f"é æ¸¬éç¨‹ç™¼ç”ŸéŒ¯èª¤: {e}")

        return jsonify({"error": f"ä¼ºæœå™¨å…§éƒ¨éŒ¯èª¤: {e}"}), 500



Churn_Bank.html

{% extends "base_Churn.html" %}



{% block title %}éŠ€è¡Œå®¢æˆ¶æµå¤±é æ¸¬ - å®¢æˆ¶æµå¤±é æ¸¬å¹³å°{% endblock %}



{% block extra_css %}

<link rel="stylesheet" href="{{ url_for('static', filename='css/Churn_Bank.css') }}">

{% endblock %}



{% block content %}

<div id="churn_bank" class="page-content">

    <h1 class="page-title">å®¢æˆ¶æµå¤±_éŠ€è¡ŒMODEL - é æ¸¬åˆ†æ (å« AI è§£é‡‹)</h1>

    

    <div class="main-panel-grid">

        

                <div class="api-key-panel card">

            <h2 class="card-title">ğŸ”‘ Gemini API å•Ÿç”¨</h2>

            <div class="api-key-container">

                <input type="password" id="apiKey" placeholder="è«‹è¼¸å…¥ Gemini API Key..." class="theme-input-field" title="åœ¨æ­¤è¼¸å…¥æ‚¨çš„ Gemini API Key">

                <button id="saveApiKeyBtn" class="analyze-btn" title="å•Ÿç”¨ Gemini AI åŠŸèƒ½">

                    <i class="fas fa-check"></i>

                    <span class="key-status-text">å•Ÿç”¨ AI</span>

                </button>

            </div>

            <p id="apiStatusMsg" class="error-message" style="margin-top: 0.5rem; color: var(--primary-color);">è«‹è¼¸å…¥ Key ä»¥å•Ÿç”¨ AI è§£é‡‹åŠŸèƒ½ã€‚</p>

        </div>



                <div class="input-and-prompt-panel card">

            

            <div class="input-section">

                <h2 class="card-title">ğŸ“ˆ å®¢æˆ¶ç‰¹å¾µè¼¸å…¥ (10 é …)</h2>

                <div id="inputForm" class="input-group">

                    <div class="input-field-container"><label>1. ä¿¡ç”¨åˆ†æ•¸ (600-850)</label><input type="number" id="input_CreditScore" data-feature-name="CreditScore" value="711.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>2. å¹´é½¡ (æ­²)</label><input type="number" id="input_Age" data-feature-name="Age" value="37.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>3. æœå‹™å¹´é™ (å¹´)</label><input type="number" id="input_Tenure" data-feature-name="Tenure" value="8.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>4. é¤˜é¡ ($)</label><input type="number" id="input_Balance" data-feature-name="Balance" value="117565.03" class="theme-input-field"></div>

                    <div class="input-field-container"><label>5. ç”¢å“æ•¸é‡ (1-4)</label><input type="number" id="input_NumOfProducts" data-feature-name="NumOfProducts" value="2.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>6. æŒæœ‰ä¿¡ç”¨å¡ (0/1)</label><input type="number" id="input_HasCrCard" data-feature-name="HasCrCard" value="1.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>7. æ´»èºæœƒå“¡ (0/1)</label><input type="number" id="input_IsActiveMember" data-feature-name="IsActiveMember" value="0.0" class="theme-input-field"></div>

                    <div class="input-field-container"><label>8. ä¼°è¨ˆè–ªè³‡ ($)</label><input type="number" id="input_EstimatedSalary" data-feature-name="EstimatedSalary" value="51112.8" class="theme-input-field"></div>

                    <div class="input-field-container"><label>9. åœ‹å®¶/åœ°å€ (0:æ³• 1:è¥¿ 2:å¾·)</label><input type="number" id="input_Geography" data-feature-name="Geography" value="2" class="theme-input-field"></div>

                    <div class="input-field-container"><label>10. æ€§åˆ¥ (0:ç”· 1:å¥³)</label><input type="number" id="input_Gender" data-feature-name="Gender" value="1" class="theme-input-field"></div>

                </div>

            </div>



            <hr class="card-divider">



            <div class="prompt-section">

                <h2 class="card-title">ğŸ’¬ AI è§£é‡‹/è¡Œå‹•å»ºè­° æŒ‡ä»¤</h2>

                <div class="input-field-container">

                    <label>è«‹è¼¸å…¥æ‚¨å¸Œæœ› AI å¦‚ä½•è§£é‡‹é æ¸¬çµæœï¼š</label>

                    <textarea id="aiPrompt" 

                              rows="5" 

                              class="theme-input-field"

                              placeholder="ä¾‹å¦‚: å‡è¨­æˆ‘æ˜¯å®¢æˆ¶ç¶“ç†ï¼Œè«‹ç”¨å°ˆæ¥­ä¸”å…·é«”çš„èªè¨€ï¼Œçµåˆè¼¸å…¥åƒæ•¸è§£é‡‹æµå¤±é¢¨éšªï¼Œä¸¦æä¾›ä¸‰å€‹å…·é«”çš„ç¶­è­·è¡Œå‹•å»ºè­°ã€‚">

å‡è¨­æˆ‘æ˜¯å®¢æˆ¶ç¶“ç†ï¼Œè«‹ç”¨å°ˆæ¥­ä¸”å…·é«”çš„èªè¨€ï¼Œçµåˆè¼¸å…¥åƒæ•¸è§£é‡‹æµå¤±é¢¨éšªï¼Œä¸¦æä¾›ä¸‰å€‹å…·é«”çš„ç¶­è­·è¡Œå‹•å»ºè­°ã€‚

</textarea>

                </div>

                

                <button id="analyzeBtn" class="analyze-btn" disabled>

                    <div id="spinner" class="loading-spinner hidden"></div>

                    <span>åŸ·è¡Œæ¨¡å‹é æ¸¬ä¸¦å–å¾— AI è§£é‡‹</span>

                </button>

                <p id="errorMsg" class="error-message hidden"></p>

            </div>

        </div>



                <div class="explanation-panel card">

            <h2 class="card-title">ğŸ’¡ AI è§£é‡‹èˆ‡è¡Œå‹•å»ºè­°</h2>

            <div id="explanationOutput" class="output-content">

                <p id="initialMessage" class="initial-message">è«‹å…ˆåœ¨ä¸Šæ–¹è¼¸å…¥ä¸¦**å•Ÿç”¨**æ‚¨çš„ Gemini API Keyï¼Œç„¶å¾Œè¼¸å…¥åƒæ•¸å’ŒæŒ‡ä»¤ï¼Œæ‰èƒ½åŸ·è¡Œåˆ†æã€‚</p>

            </div>

        </div>



                <div class="chart-panel card">

            <h2 class="card-title">ğŸ“Š æ¨¡å‹å…§å»ºè¼¸å‡ºåœ–è¡¨é¡¯ç¤ºå€ (å¯æ»¾å‹•)</h2>

            <div id="chartDisplay" class="chart-display">

                <div class="chart-placeholder">åœ–è¡¨ 1: ç‰¹å¾µé‡è¦æ€§ (Feature Importance)</div>

                <div class="chart-placeholder">åœ–è¡¨ 2: æ±ºç­–è·¯å¾‘ (SHAP / LIME Explanations)</div>

                <div class="chart-placeholder">åœ–è¡¨ 3: å®¢æˆ¶ç¾¤çµ„åˆ†ä½ˆ (Customer Segmentation)</div>

                <div class="chart-placeholder">åœ–è¡¨ 4: é æ¸¬æ©Ÿç‡åˆ†ä½ˆ (Prediction Probability)</div>

                <div class="chart-placeholder">åœ–è¡¨ 5: æ­·å²æµå¤±è¶¨å‹¢ (Historical Churn Trend)</div>

            </div>

        </div>

    </div>

</div>

{% endblock %}



{% block extra_js %}

<script src="{{ url_for('static', filename='js/Churn_Bank.js') }}"></script>

{% endblock %}



Churn_Bank.js

/**

 * Churn_Bank.js

 * éŠ€è¡Œæµå¤±é é¢å°ˆæœ‰é‚è¼¯ï¼šAPI Key è™•ç†ã€æ”¶é›†è¼¸å…¥ã€å‘¼å«å¾Œç«¯ APIã€ä¸²æ¥ Gemini API å–å¾—è§£é‡‹ã€æ¸²æŸ“çµæœ

 */



let isApiKeyActive = false;

let geminiApiKey = null;

const API_PREDICT_ENDPOINT = '/api/churn_bank/predict'; 

const API_KEY_STORAGE_KEY = 'geminiApiKey';



document.addEventListener('DOMContentLoaded', () => {

    const apiKeyInput = document.getElementById('apiKey');

    const saveApiKeyBtn = document.getElementById('saveApiKeyBtn');

    const apiStatusMsg = document.getElementById('apiStatusMsg');

    const analyzeBtn = document.getElementById('analyzeBtn');

    const initialMessage = document.getElementById('initialMessage');



    // åˆå§‹åŒ– API Key

    const storedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);

    if (storedApiKey) {

        apiKeyInput.value = storedApiKey;

        handleApiKeyActivation(storedApiKey);

    } else {

        updateUIState(false);

    }

    

    // ç¶å®š API Key å„²å­˜/å•Ÿç”¨æŒ‰éˆ•

    if (saveApiKeyBtn) {

        saveApiKeyBtn.addEventListener('click', () => {

            const key = apiKeyInput.value.trim();

            if (isApiKeyActive) {

                handleApiKeyDeactivation();

            } else if (key) {

                localStorage.setItem(API_KEY_STORAGE_KEY, key);

                handleApiKeyActivation(key);

            } else {

                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ Gemini API Keyã€‚");

            }

        });

    }



    // ç¶å®šåŸ·è¡Œåˆ†ææŒ‰éˆ•

    if (analyzeBtn) {

        analyzeBtn.addEventListener('click', runPredictionAndExplain);

    }



    function handleApiKeyActivation(key) {

        geminiApiKey = key;

        isApiKeyActive = true;

        apiKeyInput.disabled = true;

        saveApiKeyBtn.querySelector('.key-status-text').textContent = 'AI å·²å•Ÿç”¨';

        saveApiKeyBtn.style.backgroundColor = 'var(--primary-color)';

        saveApiKeyBtn.title = 'é»æ“Šå¯æ¸…é™¤ Key ä¸¦ç¦ç”¨ AI';

        apiStatusMsg.textContent = 'âœ… AI åŠŸèƒ½å·²å•Ÿç”¨ã€‚è«‹åŸ·è¡Œåˆ†æã€‚';

        apiStatusMsg.style.color = 'var(--primary-color)';

        updateUIState(true);

    }



    function handleApiKeyDeactivation() {

        localStorage.removeItem(API_KEY_STORAGE_KEY);

        geminiApiKey = null;

        isApiKeyActive = false;

        apiKeyInput.disabled = false;

        apiKeyInput.value = '';

        saveApiKeyBtn.querySelector('.key-status-text').textContent = 'å•Ÿç”¨ AI';

        saveApiKeyBtn.style.backgroundColor = 'red';

        saveApiKeyBtn.title = 'åœ¨æ­¤è¼¸å…¥æ‚¨çš„ Gemini API Key';

        apiStatusMsg.textContent = 'âŒ AI åŠŸèƒ½å·²ç¦ç”¨ï¼è«‹è¼¸å…¥ Keyã€‚';

        apiStatusMsg.style.color = 'red';

        updateUIState(false);

    }



    function updateUIState(isEnabled) {

        if (!analyzeBtn || !initialMessage) return;

        analyzeBtn.disabled = !isEnabled;

        if (isEnabled) {

            initialMessage.innerHTML = '<p class="initial-message">AI åŠŸèƒ½å·²å•Ÿç”¨ã€‚è«‹èª¿æ•´è¼¸å…¥å€¼èˆ‡æŒ‡ä»¤ï¼Œç„¶å¾Œé»æ“ŠæŒ‰éˆ•åŸ·è¡Œåˆ†æã€‚</p>';

        } else {

            initialMessage.innerHTML = '<p class="error-message">AI åŠŸèƒ½å·²ç¦ç”¨ï¼è«‹åœ¨ä¸Šæ–¹è¼¸å…¥ API Key ä¸¦é»æ“Šå•Ÿç”¨æŒ‰éˆ•ã€‚</p>';

        }

    }

});



/**

 * æ”¶é›†è¡¨å–®è¼¸å…¥æ•¸æ“š

 */

function collectInputData() {

    const inputFields = document.querySelectorAll('#inputForm input[data-feature-name]');

    const data = {};

    let allValid = true;



    inputFields.forEach(input => {

        const featureName = input.getAttribute('data-feature-name');

        let value = input.value.trim();

        if (value === "") { allValid = false; return; }

        data[featureName] = parseFloat(value);

        if (isNaN(data[featureName])) allValid = false;

    });



    if (!allValid) throw new Error("è«‹ç¢ºä¿æ‰€æœ‰è¼¸å…¥æ¬„ä½éƒ½å·²å¡«å¯«ä¸¦ç‚ºæœ‰æ•ˆæ•¸å­—ã€‚");

    return data;

}



/**

 * åŸ·è¡Œæ¨¡å‹é æ¸¬ä¸¦å–å¾— AI è§£é‡‹

 */

async function runPredictionAndExplain() {

    if (!isApiKeyActive || !geminiApiKey) {

        alert("è«‹å…ˆåœ¨ä¸Šæ–¹å•Ÿç”¨ Gemini API Keyã€‚");

        return;

    }

    const aiPrompt = document.getElementById('aiPrompt').value.trim();

    if (!aiPrompt) {

        alert("è«‹è¼¸å…¥ AI è§£é‡‹æŒ‡ä»¤ã€‚");

        return;

    }



    const analyzeBtn = document.getElementById('analyzeBtn');

    const spinner = document.getElementById('spinner');

    const errorMsg = document.getElementById('errorMsg');

    const explanationOutput = document.getElementById('explanationOutput');



    analyzeBtn.disabled = true;

    spinner.classList.remove('hidden');

    errorMsg.classList.add('hidden');

    explanationOutput.innerHTML = '<p class="initial-message flex items-center"><div class="loading-spinner"></div> æ­£åœ¨é‹è¡Œæ¨¡å‹é æ¸¬ä¸¦ç”Ÿæˆ AI è§£é‡‹ï¼Œè«‹ç¨å€™...</p>';



    try {

        const inputData = collectInputData();



        // å‘¼å«å¾Œç«¯é€²è¡Œé æ¸¬

        const predictResponse = await fetch(API_PREDICT_ENDPOINT, {

            method: 'POST',

            headers: {'Content-Type': 'application/json'},

            body: JSON.stringify(inputData)

        });

        const predictResult = await predictResponse.json();



        if (predictResponse.status !== 200 || predictResult.error) {

            throw new Error(predictResult.error || `é æ¸¬ API éŒ¯èª¤ (Status: ${predictResponse.status})`);

        }



        const churnProb = predictResult.prediction;

        const inputDataString = JSON.stringify(inputData, null, 2);

        const fullPrompt = `æ¨¡å‹é æ¸¬çš„å®¢æˆ¶æµå¤±æ©Ÿç‡ç‚º ${(churnProb * 100).toFixed(2)}%ã€‚å®¢æˆ¶è¼¸å…¥ç‰¹å¾µå¦‚ä¸‹ï¼š\n${inputDataString}\n\nè«‹æ ¹æ“šä»¥ä¸Šè³‡è¨Šï¼Œä¸¦éµå¾ªä»¥ä¸‹ä½¿ç”¨è€…æŒ‡ä»¤ï¼Œæä¾›çµæ§‹åŒ–è§£é‡‹å’Œè¡Œå‹•å»ºè­°ï¼š\n\nã€ä½¿ç”¨è€…æŒ‡ä»¤ã€‘\n${aiPrompt}`;



        explanationOutput.innerHTML = `

            <div class="prediction-result">

                <h3 class="text-lg font-bold mb-3 text-red-700">ã€æ¨¡å‹é æ¸¬çµæœã€‘</h3>

                <p class="text-xl font-extrabold mb-4">æµå¤±æ©Ÿç‡: 

                    <span class="prob-value ${churnProb > 0.5 ? 'high-risk' : 'low-risk'}">

                        ${(churnProb * 100).toFixed(2)}%

                    </span> 

                    (${churnProb > 0.5 ? 'âš ï¸' : 'âœ…'} ${churnProb > 0.5 ? 'é«˜é¢¨éšªæµå¤±å®¢æˆ¶' : 'ä½é¢¨éšªæµå¤±å®¢æˆ¶'})

                </p>

            </div>

            <hr class="card-divider">

            <h3 class="card-title">ã€AI é¢¨æ§å°ˆå®¶è§£é‡‹ (ç”Ÿæˆä¸­...)ã€‘</h3>

            <p class="loading-message">æ­£åœ¨ç”Ÿæˆ AI è§£é‡‹èˆ‡è¡Œå‹•å»ºè­°...</p>

        `;



        const explanation = await getAiExplanation(fullPrompt, geminiApiKey);

        explanationOutput.querySelector('.loading-message').outerHTML = explanation;



        // æ¨¡æ“¬åœ–è¡¨

        const chartData = {

            featuresImportance: "<ul><li>ä¿¡ç”¨åˆ†æ•¸: 0.25</li><li>å¹´é½¡: 0.12</li><li>é¤˜é¡: 0.10</li>...</ul>",

            decisionPath: "<p>å¦‚æœ **ä¿¡ç”¨åˆ†æ•¸ < 650** ä¸” **æ´»èºæœƒå“¡ = 0** â†’ é«˜é¢¨éšª</p>",

            customerSegment: "<p>å±¬æ–¼ **é«˜é¤˜é¡/ä½æ´»å‹•** ç¾¤çµ„</p>",

            probDist: "<p>ç•¶å‰å®¢æˆ¶çš„æ©Ÿç‡å€¼ä½æ–¼æ©Ÿç‡åˆ†ä½ˆçš„ **ç¬¬ 80 ç™¾åˆ†ä½æ•¸**ã€‚</p>",

            historyTrend: "<p>éå» 12 å€‹æœˆå¹³å‡æµå¤±ç‡: 15%</p>"

        };

        renderModelCharts(chartData);



    } catch (error) {

        console.error("é æ¸¬æˆ–è§£é‡‹å¤±æ•—:", error);

        errorMsg.textContent = `éŒ¯èª¤: ${error.message}`;

        errorMsg.classList.remove('hidden');

        explanationOutput.innerHTML = '<p class="error-message">é æ¸¬æˆ– AI è§£é‡‹å¤±æ•—ã€‚</p>';

    } finally {

        analyzeBtn.disabled = !isApiKeyActive;

        spinner.classList.add('hidden');

    }

}



/**

 * å‘¼å« Gemini API å–å¾—è§£é‡‹ (ä¿®æ­£ç‚º generateContent çš„æ­£ç¢ºæ ¼å¼)

 */

async function getAiExplanation(prompt, apiKey) {

    const GEMINI_API_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent";

    

    // âœ… ä¿®æ­£å¾Œçš„ JSON body çµæ§‹

    const body = {

        // ä½¿ç”¨ contents é™£åˆ—

        contents: [

            {

                role: "user",

                parts: [

                    { text: prompt } // ä½¿ç”¨ parts é™£åˆ—

                ]

            }

        ],

        // ä½¿ç”¨ generationConfig åŒ…å«æ‰€æœ‰å¯é¸åƒæ•¸

        generationConfig: {

            temperature: 0.7,

            maxOutputTokens: 500

        }

    };



    const response = await fetch(`${GEMINI_API_URL}?key=${apiKey}`, {

        method: 'POST',

        headers: { 'Content-Type': 'application/json' },

        body: JSON.stringify(body)

    });



    const result = await response.json();



    if (!response.ok || result.error) {

        const errorDetail = result.error ? result.error.message : JSON.stringify(result);

        throw new Error(`Gemini API å‘¼å«å¤±æ•—: ${errorDetail}`);

    }

    

    // âœ… ä¿®æ­£äº†ç²å–å›å‚³æ–‡æœ¬çš„è·¯å¾‘

    const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text || "ç„¡æ³•å–å¾—å›å‚³å…§å®¹"; 



    // Markdown è½‰æ›é‚è¼¯ä¿æŒä¸è®Š

    let htmlText = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')

                        .replace(/### (.*)/g, '<h3>$1</h3>')

                        .replace(/## (.*)/g, '<h2>$1</h2>')

                        .replace(/\n\s*\*\s+/g, '<br>â€¢ ')

                        .replace(/\n/g, '<p>');



    htmlText = htmlText.replace(/^(<p>)+/, '');



    return `<div class="ai-explanation">${htmlText}</div>`;

}



/**

 * æ¸²æŸ“æ¨¡å‹åœ–è¡¨

 */

function renderModelCharts(data) {

    const chartContainer = document.getElementById('chartDisplay');

    if (!chartContainer) return;



    chartContainer.innerHTML = '';

    const charts = [

        { title: "ç‰¹å¾µé‡è¦æ€§ (Feature Importance)", content: data.featuresImportance },

        { title: "æ±ºç­–è·¯å¾‘ (Decision Path / SHAP)", content: data.decisionPath },

        { title: "å®¢æˆ¶ç¾¤çµ„åˆ†ä½ˆ (Customer Segmentation)", content: data.customerSegment },

        { title: "é æ¸¬æ©Ÿç‡åˆ†ä½ˆ (Prediction Probability)", content: data.probDist },

        { title: "æ­·å²æµå¤±è¶¨å‹¢ (Historical Churn Trend)", content: data.historyTrend }

    ];



    charts.forEach(chart => {

        const div = document.createElement('div');

        div.className = 'chart-placeholder';

        div.innerHTML = `<h4>${chart.title}</h4>${chart.content}`;

        chartContainer.appendChild(div);

    });



    const footer = document.createElement('p');

    footer.className = 'chart-footer-message';

    footer.textContent = 'ä½¿ç”¨ä¸Šä¸‹æ‹‰æ¡¿æª¢è¦–æ‰€æœ‰ç›¸é—œåœ–è¡¨ã€‚';

    chartContainer.appendChild(footer);

}

æˆ‘æƒ³è¦å‰ç«¯

å®¢æˆ¶ç‰¹å¾µè¼¸å…¥->ç‰¹å¾µç¶“éæ¨¡å‹å¾—å‡ºåœ–è¡¨->æ¨¡å‹å…§å»ºè¼¸å‡ºåœ–è¡¨é¡¯ç¤ºå€

ç›®å‰æ¨¡å‹å…§å»ºè¼¸å‡ºåœ–è¡¨é¡¯ç¤ºå€åªæœ‰é¡¯ç¤ºæ•¸æ“š æ²’æœ‰åœ–ç‰‡

æˆ‘æƒ³ç”¢ç”Ÿåœ–ç‰‡è©²æ€éº¼åš

ä»¥åŠ

Gemini API å•Ÿç”¨å¾Œ->åŸ·è¡Œæ¨¡å‹é æ¸¬ä¸¦å–å¾— AI è§£é‡‹->AI è§£é‡‹èˆ‡è¡Œå‹•å»ºè­°

AI è§£é‡‹èˆ‡è¡Œå‹•å»ºè­°æ²’æœ‰è·‘å‡ºä¾†

è§£æ±ºä»¥ä¸Šå…©é»å•é¡Œ