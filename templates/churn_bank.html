{% extends "base_churn.html" %}

{% block title %}銀行客戶流失預測 - 客戶流失預測平台{% endblock %}

{% block extra_css %}
<!-- 載入 Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- 載入 Font Awesome Icons -->
 <link rel="stylesheet" href="{{ url_for('static', filename='css/churn_bank.css') }}">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
<!-- <link rel="stylesheet" href="{{ url_for('static', filename='css/churn_bank.css') }}"> -->
{% endblock %}

{% block content %}
<div id="churn_bank" class="page-content">
    <h1 class="page-title">客戶流失_銀行MODEL - 預測分析 (含 AI 解釋)</h1>
    
    <div class="main-panel-grid">
        
        <!-- API Key Panel -->
        <div class="api-key-panel card">
            <h2 class="card-title"><i class="fas fa-key mr-2"></i> Gemini API 啟用</h2>
            <div class="api-key-container">
                <input type="password" id="apiKey" placeholder="請輸入 Gemini API Key..." class="theme-input-field" title="在此輸入您的 Gemini API Key">
                <button id="saveApiKeyBtn" class="analyze-btn analyze-predict-only" title="啟用 Gemini AI 功能">
                    <i class="fas fa-check"></i>
                    <span class="key-status-text">尚未啟用</span>
                </button>
            </div>
            <p id="apiStatusMsg" class="text-sm mt-2 text-red-500">請輸入 Key 以啟用 AI 解釋功能。</p>
        </div>

        <!-- Input and Prompt Panel (Now spans across the grid on large screens) -->
        <div class="input-and-prompt-panel card">
            
            <!-- Batch Upload -->
            <div class="batch-upload-container">
                <h2 class="card-title"><i class="fas fa-upload mr-2"></i> 批次 CSV 分析/客戶單筆輸入</h2>
                <hr class="card-divider">
                <div class="batch-upload-area">
                    <h3 class="card-title text-base font-semibold" style="margin-bottom: 0.5rem;"><i class="fas fa-file-csv mr-1"></i> 批次 CSV 分析</h3>
                    <p class="text-sm text-gray-500 mb-4">上傳包含客戶資料的 CSV 檔案進行批次預測。</p>
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input type="file" id="csvFileInput" accept=".csv" class="theme-input-field flex-grow cursor-pointer" style="max-width: unset;">
                        <button id="uploadBatchBtn" class="analyze-btn analyze-predict-only">
                            <i class="fas fa-upload mr-1"></i>
                            <span>上傳並批次預測</span>
                        </button>
                    </div>
                </div>
            </div>

            <hr class="card-divider">

            <!-- Single Customer Input -->
            <div class="input-section">
                <h2 class="card-title"><i class="fas fa-user-edit mr-2"></i> 單筆客戶特徵輸入 (10 項)</h2>
                <!-- === Improvement: Use a responsive grid for input fields === -->
                <div id="inputForm" class="grid grid-cols-1 sm:grid-cols-2 gap-4 mt-4">
                    <div class="input-field-container">
                        <label>1. 信用分數 ( 350 - 850 )</label>
                        <input type="number" id="input_CreditScore" data-feature-name="CreditScore" value="700" step="1" class="theme-input-field">
                    </div>
                    <div class="input-field-container">
                        <label>2. 年齡 ( 18 - 100 歲 )</label>
                        <input type="number" id="input_Age" data-feature-name="Age" value="35" step="1" class="theme-input-field">
                    </div>
                    <div class="input-field-container">
                        <label>3. 服務年限 ( 0 - 10 年 )</label>
                        <input type="number" id="input_Tenure" data-feature-name="Tenure" value="8" step="1" class="theme-input-field">
                    </div>
                    <div class="input-field-container">
                        <label>4. 餘額 ( 0-300000 $ )</label>
                        <input type="number" id="input_Balance" data-feature-name="Balance" value="150000" class="theme-input-field">
                    </div>
                    
                    <!-- Dropdown for NumOfProducts -->
                    <div class="input-field-container dropdown-container" data-dropdown-id="NumOfProducts">
                        <label>5. 產品數量 ( 1 - 4 )</label>
                        <input type="text" id="input_NumOfProducts" data-feature-name="NumOfProducts" data-value="2" value="2" readonly class="theme-input-field dropdown-input" placeholder="選擇產品數量">
                        <div class="dropdown-list hidden">
                            <div class="dropdown-item" data-value="1">1</div>
                            <div class="dropdown-item" data-value="2">2</div>
                            <div class="dropdown-item" data-value="3">3</div>
                            <div class="dropdown-item" data-value="4">4</div>
                        </div>
                    </div>
                    
                    <!-- Dropdown for HasCrCard -->
                    <div class="input-field-container dropdown-container" data-dropdown-id="HasCrCard">
                        <label>6. 持有信用卡 ( 0 : 否 / 1 : 是 )</label>
                        <input type="text" id="input_HasCrCard" data-feature-name="HasCrCard" data-value="1" value="1 (是)" readonly class="theme-input-field dropdown-input" placeholder="選擇是否持有信用卡">
                        <div class="dropdown-list hidden">
                            <div class="dropdown-item" data-value="0">0 (否)</div>
                            <div class="dropdown-item" data-value="1">1 (是)</div>
                        </div>
                    </div>
                    
                    <!-- Dropdown for IsActiveMember -->
                    <div class="input-field-container dropdown-container" data-dropdown-id="IsActiveMember">
                        <label>7. 活躍會員 ( 0 : 否 / 1 : 是 )</label>
                        <input type="text" id="input_IsActiveMember" data-feature-name="IsActiveMember" data-value="1" value="1 (是)" readonly class="theme-input-field dropdown-input" placeholder="選擇是否為活躍會員">
                        <div class="dropdown-list hidden">
                            <div class="dropdown-item" data-value="0">0 (否)</div>
                            <div class="dropdown-item" data-value="1">1 (是)</div>
                        </div>
                    </div>
                    
                    <div class="input-field-container">
                        <label>8. 估計薪資 ( 0 - 200000 $ )</label>
                        <input type="number" id="input_EstimatedSalary" data-feature-name="EstimatedSalary" value="100000" class="theme-input-field">
                    </div>

                    <!-- Dropdown for Geography -->
                    <div class="input-field-container dropdown-container" data-dropdown-id="Geography">
                        <label>9. 國家/地區 ( 0 : 法國 1 : 西班牙 2 : 德國 )</label>
                        <input type="text" id="input_Geography" data-feature-name="Geography" data-value="2" value="2 (德國)" readonly class="theme-input-field dropdown-input" placeholder="選擇國家/地區">
                        <div class="dropdown-list hidden">
                            <div class="dropdown-item" data-value="0">0 (法國)</div>
                            <div class="dropdown-item" data-value="1">1 (西班牙)</div>
                            <div class="dropdown-item" data-value="2">2 (德國)</div>
                        </div>
                    </div>
                    
                    <!-- Dropdown for Gender -->
                    <div class="input-field-container dropdown-container" data-dropdown-id="Gender">
                        <label>10. 性別 ( 0 : 男 / 1 : 女 )</label>
                        <input type="text" id="input_Gender" data-feature-name="Gender" data-value="1" value="1 (女)" readonly class="theme-input-field dropdown-input" placeholder="選擇性別">
                        <div class="dropdown-list hidden">
                            <div class="dropdown-item" data-value="0">0 (男)</div>
                            <div class="dropdown-item" data-value="1">1 (女)</div>
                        </div>
                    </div>
                </div>
            </div>

            <hr class="card-divider">

            <!-- AI Prompt Section -->
            <div class="prompt-section">
                <h2 class="card-title"><i class="fas fa-comment-dots mr-2"></i> AI 解釋/行動建議 指令</h2>
                <div class="input-field-container">
                    <label>請輸入您希望 AI 如何解釋預測結果：</label>
                    <textarea id="aiPrompt" 
                                rows="5" 
                                class="theme-input-field"
                                placeholder="例如: 假設我是客戶經理，請用專業且具體的語言，結合輸入參數解釋流失風險，並提供三個具體的維護行動建議。">請作為一名資產管理顧問，根據客戶的流失機率和輸入特徵，提供一份專業的風險分析報告，包含：1. 風險評估等級。2. 主要風險點。3. 建議採取的客戶留存行動。請使用條列式呈現並且簡單扼要，約500個Tokens內。</textarea>
                </div>
                
                <div class="action-buttons-container flex flex-col sm:flex-row gap-3 mt-4">
                    <button id="analyzeBtn" class="analyze-btn analyze-full flex-grow" disabled>
                        <i class="fas fa-robot mr-1"></i>
                        <span>執行模型預測並取得 AI 解釋</span>
                    </button>
                    
                    <button id="predictOnlyBtn" class="analyze-btn analyze-predict-only flex-grow">
                        <i class="fas fa-chart-line mr-1"></i>
                        <span>僅執行模型預測</span>
                    </button>
                </div>
                <p id="errorMsg" class="text-sm mt-3 text-red-500 hidden"></p> 
            </div>
        </div>

        <!-- AI Explanation Panel -->
        <div class="explanation-panel card">
            <h2 class="card-title"><i class="fas fa-lightbulb mr-2"></i> AI 解釋與行動建議</h2>
            <div id="explanationOutput" class="output-content">
                <p id="initialMessage" class="initial-message">請先在上方輸入並**啟用**您的 Gemini API Key，然後輸入參數和指令，才能執行分析。</p>
            </div>
        </div>

        <!-- Chart Panel -->
        <div class="chart-panel card">
            <h2 class="card-title"><i class="fas fa-chart-area mr-2"></i> 模型內建輸出圖表顯示區</h2>
            <div id="chartDisplay" class="chart-display grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="chart-placeholder flex items-center justify-center">圖表 1: **單一客戶局部 SHAP 影響力**</div>
                <div class="chart-placeholder flex items-center justify-center">圖表 2: **模型全局 SHAP 摘要圖**</div>
            </div>
        </div>
    </div>

    <!-- Batch Result Panel -->
    <hr class="card-divider mt-8">
    <div id="batch-result-panel" class="card mt-6" style="display: none;">
        <h2 class="card-title"><i class="fas fa-table mr-2"></i> 批次分析結果列表</h2>
        
        <div class="filter-controls">
            
            <!-- ID Search -->
            <div class="flex items-center gap-2">
                <label for="idSearchInput" class="font-bold whitespace-nowrap text-gray-700">ID 搜索:</label>
                <input type="text" id="idSearchInput" placeholder="輸入 ID 快速搜索..." class="theme-input-field w-32">
            </div>
            
            <!-- Probability Filter -->
            <div class="flex items-center gap-2">
                <label for="thresholdInput" class="whitespace-nowrap text-gray-700">篩選流失機率大於：</label>
                <input type="number" id="thresholdInput" value="50" min="0" max="100" step="1" class="theme-input-field text-center" style="width: 70px;">
                <span class="whitespace-nowrap">%</span>
                <button id="filterDataBtn" class="analyze-btn analyze-predict-only text-sm">
                    <i class="fas fa-filter mr-1"></i> 執行篩選
                </button>
            </div>
            
            <div class="filter-stats text-sm text-gray-600" id="filterStats">
                <!-- Filter stats will be injected here -->
            </div>
        </div>
        
        <div class="table-wrapper mt-4 overflow-x-auto">
            <table class="fl-table">
                <thead>
                    <tr>
                        <th id="sortId" data-sort-key="id" data-sort-order="none">
                            ID <span class="sort-icon"><i class="fas fa-sort"></i></span>
                        </th>
                        <th id="sortProbability" data-sort-key="probability" data-sort-order="none">
                            流失機率 <span class="sort-icon"><i class="fas fa-sort"></i></span>
                        </th>
                        <th id="sortRisk" data-sort-key="risk" data-sort-order="none">
                            風險等級 <span class="sort-icon"><i class="fas fa-sort"></i></span>
                        </th>
                        <!-- Add other relevant data columns here if needed, e.g., Age, Balance, etc. -->
                    </tr>
                </thead>
                <tbody id="batchResultBody">
                    <tr><td colspan="3" class="text-center p-5 text-gray-400">請上傳 CSV 檔案進行批次分析</td></tr>
                </tbody>
            </table>
        </div>

        <!-- Pagination Controls -->
        <div class="pagination-controls" id="paginationControls" style="display: flex; justify-content: center; align-items: center; gap: 10px; margin-top: 1rem;">
            <button id="prevPageBtn" class="analyze-btn analyze-predict-only text-sm"><i class="fas fa-chevron-left"></i> 上一頁</button>
            <label for="pageInput" class="text-gray-700">前往:</label>
            <input type="number" id="pageInput" value="1" min="1" class="theme-input-field text-center" style="width: 60px;">
            <span id="pageInfo" class="text-gray-700"> / ?</span>
            <button id="nextPageBtn" class="analyze-btn analyze-predict-only text-sm">下一頁 <i class="fas fa-chevron-right"></i></button>
        </div>
        
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{{ url_for('static', filename='js/churn_bank.js') }}"></script>
{% endblock %}